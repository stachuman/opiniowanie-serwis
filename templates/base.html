<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ title or "Opinie sądowe" }}</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
        rel="stylesheet" crossorigin="anonymous">

  <!-- Bootstrap‑Icons CSS (LOCAL) -->
  <link rel="stylesheet"
        href="{{ url_for('static', path='bootstrap-icons/bootstrap-icons.css') }}">

  <style>
    tr[data-href]         { cursor: pointer; }
    tr[data-href]:hover   { background-color: #f8f9fa; }

    /* Stylowanie breadcrumbs */
    .breadcrumb-container {
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      padding: 0.75rem 0;
      margin-bottom: 1.5rem;
    }

    /* Usprawnienie nawigacji kontekstowej */
    .context-nav {
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .page-title {
      margin: 0;
      flex-grow: 1;
    }

    .page-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* Responsywność dla mniejszych ekranów */
    @media (max-width: 768px) {
      .page-header {
        flex-direction: column;
        align-items: stretch;
      }

      .page-actions {
        justify-content: center;
      }

      .breadcrumb-container {
        padding: 0.5rem 0;
      }
    }

    /* Aktywne elementy nawigacji */
    .nav-link.active {
      font-weight: 600;
    }
  </style>
</head>

<body class="bg-light">

  <!-- ==========  Navbar główna  ========== -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('list_opinions') }}">
        <i class="bi bi-briefcase me-2"></i>Court Workflow
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbars" aria-controls="navbars" aria-expanded="false"
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbars">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link {{ 'active' if request.url.path == url_for('list_opinions') else '' }}"
               href="{{ url_for('list_opinions') }}">
              <i class="bi bi-list"></i> Lista opinii
            </a>
          </li>

          <!-- Dropdown dla nowych opinii -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle {{ 'active' if request.url.path in [url_for('upload_form'), url_for('create_empty_opinion_form'), url_for('quick_ocr_form')] else '' }}"
               href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-plus-circle"></i> Nowa opinia
            </a>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item" href="{{ url_for('upload_form') }}">
                  <i class="bi bi-file-earmark-word me-2"></i>Z dokumentu Word
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="{{ url_for('create_empty_opinion_form') }}">
                  <i class="bi bi-file-earmark me-2"></i>Pusta opinia
                </a>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <a class="dropdown-item" href="{{ url_for('quick_ocr_form') }}">
                  <i class="bi bi-lightning me-2"></i>Szybki OCR
                </a>
              </li>
            </ul>
          </li>

          <li class="nav-item">
            <a class="nav-link {{ 'active' if request.url.path == url_for('list_documents') else '' }}"
               href="{{ url_for('list_documents') }}">
              <i class="bi bi-files"></i> Wszystkie dokumenty
            </a>
          </li>
        </ul>

        {% block nav_extra %}{% endblock %}
      </div>
    </div>
  </nav>

  <!-- ==========  Breadcrumbs  ========== -->
  {% if breadcrumbs and breadcrumbs|length > 0 %}
  <div class="breadcrumb-container">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          {% for crumb in breadcrumbs %}
            {% if loop.last %}
              <li class="breadcrumb-item active" aria-current="page">
                {% if crumb.icon %}<i class="bi bi-{{ crumb.icon }} me-1"></i>{% endif %}
                {{ crumb.name }}
              </li>
            {% else %}
              <li class="breadcrumb-item">
                <a href="{{ crumb.url }}">
                  {% if crumb.icon %}<i class="bi bi-{{ crumb.icon }} me-1"></i>{% endif %}
                  {{ crumb.name }}
                </a>
              </li>
            {% endif %}
          {% endfor %}
        </ol>
      </nav>
    </div>
  </div>
  {% endif %}

  <!-- ==========  Główna zawartość  ========== -->
  <main class="container py-4">

    <!-- Nagłówek strony z akcjami -->
    {% if page_title or page_actions %}
    <div class="page-header">
      {% if page_title %}
        <h1 class="page-title">{{ page_title }}</h1>
      {% endif %}

      {% if page_actions and page_actions|length > 0 %}
        <div class="page-actions">
          {% for action in page_actions %}
            <a href="{{ action.url }}"
               class="btn {{ action.class or 'btn-outline-primary' }}"
               {% if action.data_bs_toggle %}data-bs-toggle="{{ action.data_bs_toggle }}"{% endif %}
               {% if action.data_bs_target %}data-bs-target="{{ action.data_bs_target }}"{% endif %}
               title="{{ action.name }}">
              {% if action.icon %}<i class="bi bi-{{ action.icon }} me-1"></i>{% endif %}
              {{ action.name }}
            </a>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Kontekstowa nawigacja/informacje -->
    {% if context_info and context_info|length > 0 %}
    <div class="context-nav">
      <div class="row g-3">
        {% for info in context_info %}
          <div class="col-md-3">
            <small class="text-muted">{{ info.label }}:</small><br>
            {% if info.badge_class %}
              <span class="badge {{ info.badge_class }} p-2">
                {% if step_icon and info.label == "Status" %}<i class="bi bi-{{ step_icon }} me-1"></i>{% endif %}
                {{ info.value }}
              </span>
            {% else %}
              <strong>{{ info.value }}</strong>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Dodatkowy blok kontekstowy dla specyficznych stron -->
    {% block context_nav %}{% endblock %}

    <!-- Główna zawartość -->
    {% block content %}{% endblock %}
  </main>

  <footer class="text-center text-muted my-4 small">
    &copy; 2025 Court Workflow
  </footer>

  <!-- Bootstrap JS (bundle) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
          crossorigin="anonymous"></script>

  <!-- ===== WSPÓLNE NARZĘDZIA SCHOWKA ===== -->
  <script>
  /**
   * Kopiuje tekst do schowka (Clipboard API + fallback).
   * @param {string} text - Tekst do skopiowania
   * @param {Function} [callback] - Opcjonalna funkcja callback wykonywana po udanym kopiowaniu
   * @returns {Promise<void>}
   */
  window.copyTextToClipboard = async function (text, callback) {
    if (!text || !text.trim()) {
      throw new Error('Brak tekstu do skopiowania');
    }
    
    console.log('copyTextToClipboard - rozpoczęcie kopiowania, długość tekstu:', text.length);
    console.log('Dostępność Clipboard API:', !!navigator.clipboard?.writeText);
    console.log('Protokół:', window.location.protocol);
    console.log('Context jest bezpieczny:', window.isSecureContext);

    try {
      // Najpierw spróbuj nowoczesny Clipboard API
      if (navigator.clipboard?.writeText && window.isSecureContext) {
        console.log('Próba kopiowania przez Clipboard API...');
        await navigator.clipboard.writeText(text);
        console.log('Clipboard API - sukces');

        // Sprawdź czy rzeczywiście skopiowano
        try {
          const clipboardContent = await navigator.clipboard.readText();
          if (clipboardContent === text) {
            console.log('Weryfikacja: tekst rzeczywiście w schowku');
          } else {
            console.warn('Weryfikacja: tekst w schowku różni się od oczekiwanego');
          }
        } catch (readError) {
          console.warn('Nie można odczytać schowka dla weryfikacji:', readError.message);
        }

      } else {
        console.log('Clipboard API niedostępne, używam fallback...');
        // Fallback dla starszych przeglądarek lub niezabezpieczonych kontekstów
        const success = await fallbackCopyToClipboard(text);
        if (!success) {
          throw new Error('Fallback method failed');
        }
        console.log('Fallback method - sukces');
      }

      // Jeśli podano callback, wywołaj go
      if (typeof callback === 'function') {
        callback();
      }

    } catch (err) {
      console.error('Wszystkie metody kopiowania zawiodły:', err);
      throw new Error('Nie udało się skopiować tekstu do schowka: ' + err.message);
    }
  };

  /**
   * Fallback metoda kopiowania dla starszych przeglądarek
   * @param {string} text
   * @returns {Promise<boolean>}
   */
  async function fallbackCopyToClipboard(text) {
    console.log('Rozpoczęcie fallback copy method...');

    return new Promise((resolve) => {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      ta.style.top = '0';
      ta.style.opacity = '0';
      ta.style.pointerEvents = 'none';
      ta.style.zIndex = '-1';

      document.body.appendChild(ta);

      try {
        ta.focus();
        ta.select();
        ta.setSelectionRange(0, text.length);

        console.log('Textarea utworzona i zaznaczona, próba execCommand...');

        const successful = document.execCommand('copy');
        console.log('execCommand result:', successful);

        document.body.removeChild(ta);

        if (successful) {
          console.log('execCommand - sukces');
          resolve(true);
        } else {
          console.error('execCommand - niepowodzenie');
          resolve(false);
        }

      } catch (error) {
        console.error('Błąd w fallback method:', error);
        document.body.removeChild(ta);
        resolve(false);
      }
    });
  }

  /**
   * Alternatywna metoda kopiowania specjalnie dla modali
   * @param {string} text
   * @returns {Promise<boolean>}
   */
  async function aggressiveCopyToClipboard(text) {
    console.log('Aggressywna metoda kopiowania...');

    // Metoda 1: Spróbuj z fokusem na body
    try {
      document.body.focus();
      if (navigator.clipboard?.writeText && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        console.log('Agresywna metoda 1 (Clipboard API) - sukces');
        return true;
      }
    } catch (e) {
      console.log('Agresywna metoda 1 nie powiodła się:', e.message);
    }

    // Metoda 2: Użyj textarea z focusem na dokumencie
    try {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'absolute';
      ta.style.left = '0';
      ta.style.top = '0';
      ta.style.width = '1px';
      ta.style.height = '1px';
      ta.style.padding = '0';
      ta.style.border = 'none';
      ta.style.outline = 'none';
      ta.style.boxShadow = 'none';
      ta.style.background = 'transparent';
      ta.style.zIndex = '9999';

      // Dodaj do body, nie do modala
      document.body.appendChild(ta);

      // Spróbuj różne metody fokusowania
      ta.focus({ preventScroll: true });
      ta.select();

      // Dodatkowe zaznaczenie
      if (ta.setSelectionRange) {
        ta.setSelectionRange(0, text.length);
      }

      // Krótka pauza przed execCommand
      await new Promise(resolve => setTimeout(resolve, 50));

      const successful = document.execCommand('copy');
      console.log('Agresywna metoda 2 (execCommand) - wynik:', successful);

      document.body.removeChild(ta);

      if (successful) {
        return true;
      }
    } catch (e) {
      console.log('Agresywna metoda 2 nie powiodła się:', e.message);
    }

    // Metoda 3: Użyj selection API
    try {
      const range = document.createRange();
      const selection = window.getSelection();

      const span = document.createElement('span');
      span.textContent = text;
      span.style.position = 'absolute';
      span.style.left = '-9999px';
      document.body.appendChild(span);

      range.selectNode(span);
      selection.removeAllRanges();
      selection.addRange(range);

      const successful = document.execCommand('copy');
      console.log('Agresywna metoda 3 (Selection API) - wynik:', successful);

      selection.removeAllRanges();
      document.body.removeChild(span);

      if (successful) {
        return true;
      }
    } catch (e) {
      console.log('Agresywna metoda 3 nie powiodła się:', e.message);
    }

    return false;
  }

  /**
   * Ulepszona funkcja kopiowania z wieloma fallbackami
   * @param {string} text
   * @param {Function} callback
   */
  window.copyTextToClipboardAggressive = async function(text, callback) {
    if (!text || !text.trim()) {
      throw new Error('Brak tekstu do skopiowania');
    }

    console.log('copyTextToClipboardAggressive - rozpoczęcie...');

    try {
      // Najpierw standardowa metoda
      await window.copyTextToClipboard(text);
      console.log('Standardowa metoda zadziałała');

      if (typeof callback === 'function') {
        callback();
      }
      return;
    } catch (standardError) {
      console.log('Standardowa metoda nie powiodła się, próbuję agresywnej...', standardError.message);
    }

    // Jeśli standardowa nie zadziałała, użyj agresywnej
    try {
      const success = await aggressiveCopyToClipboard(text);
      if (success) {
        console.log('Agresywna metoda zadziałała');
        if (typeof callback === 'function') {
          callback();
        }
        return;
      }
    } catch (aggressiveError) {
      console.log('Agresywna metoda nie powiodła się:', aggressiveError.message);
    }

    throw new Error('Wszystkie metody kopiowania zawiodły');
  };

  /**
   * Krótkie „potwierdzenie" na przycisku (zamiana ikony/klasy na 2 s).
   * @param {HTMLElement} btn
   */
  window.flashCopied = function (btn) {
    const prev = btn.innerHTML;
    const prevClasses = Array.from(btn.classList);

    btn.innerHTML = '<i class="bi bi-check2"></i> Skopiowano!';
    btn.classList.remove('btn-outline-secondary', 'btn-outline-primary');
    btn.classList.add('btn-success');

    setTimeout(() => {
      btn.innerHTML = prev;
      btn.className = ''; // Wyczyść wszystkie klasy
      prevClasses.forEach(cls => btn.classList.add(cls)); // Przywróć oryginalne klasy
    }, 2000);
  };

  /**
   * Obsługa globalna – każdy element z data-copy-target kopiuje wskazany selektor.
   */
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-copy-target]');
    if (!btn) return;

    console.log('Globalny handler kopiowania - kliknięcie na przycisk z data-copy-target');

    const targetSel = btn.getAttribute('data-copy-target');
    console.log('Cel do skopiowania:', targetSel);

    const targetEl = document.querySelector(targetSel);
    if (!targetEl) {
      console.warn('Nie znaleziono elementu do skopiowania:', targetSel);
      alert('Błąd: nie można znaleźć elementu do skopiowania');
      return;
    }

    try {
      const textToCopy = targetEl.innerText || targetEl.textContent || '';
      console.log('Tekst do skopiowania (pierwsze 50 znaków):', textToCopy.substring(0, 50));

      if (!textToCopy.trim()) {
        console.warn('Brak tekstu do skopiowania');
        alert('Brak tekstu do skopiowania');
        return;
      }

      await window.copyTextToClipboard(textToCopy);
      window.flashCopied(btn);
      console.log('Globalne kopiowanie zakończone pomyślnie');
    } catch (error) {
      console.error('Błąd globalnego kopiowania:', error);
      alert('Nie udało się skopiować tekstu do schowka: ' + error.message);
    }
  });

  /**
   * Pomocnicza funkcja dla kompatybilności wstecznej
   * @param {string} text
   * @param {Function} successCallback
   * @param {Function} errorCallback
   */
  window.copyToClipboard = async function(text, successCallback, errorCallback) {
    try {
      await window.copyTextToClipboard(text);
      if (typeof successCallback === 'function') {
        successCallback();
      }
    } catch (error) {
      if (typeof errorCallback === 'function') {
        errorCallback(error);
      } else {
        console.error('Błąd kopiowania:', error);
      }
    }
  };
  </script>

  <!-- Klikalny wiersz tabeli -->
  <script>
  document.querySelectorAll('tr[data-href]').forEach(row => {
    row.addEventListener('click', function(e) {
      // Nie nawiguj, jeśli kliknięto przycisk lub wewnątrz przycisku
      if (e.target.closest('button') || e.target.closest('a') || e.target.tagName === 'BUTTON' || e.target.tagName === 'A') {
        return;
      }
      window.location = row.dataset.href;
    });
  });
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>