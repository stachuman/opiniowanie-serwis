<!-- templates/word_preview.html -->
{% extends 'base.html' %}

{% block content %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="bi bi-file-earmark-word text-primary me-2"></i>
      Podgląd dokumentu Word: {{ doc.original_filename }}
    </h5>
    <div class="btn-group">
      <!-- Przyciski akcji -->
      <a href="{{ url_for('document_detail', doc_id=doc.id) }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Szczegóły
      </a>
      <a href="{{ url_for('document_download', doc_id=doc.id) }}" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-download"></i> Pobierz
      </a>
      {% if doc.mime_type and 'word' in doc.mime_type %}
      <a href="{{ url_for('document_update_form', doc_id=doc.id) }}" class="btn btn-sm btn-outline-warning">
        <i class="bi bi-pencil"></i> Aktualizuj
      </a>
      {% endif %}
    </div>
  </div>

  <div class="card-body">
    {% if error_message %}
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Błąd:</strong> {{ error_message }}
      </div>

      <div class="text-center mt-4">
        <a href="{{ url_for('document_download', doc_id=doc.id) }}" class="btn btn-primary">
          <i class="bi bi-download"></i> Pobierz dokument Word
        </a>
      </div>

    {% elif content %}
      <!-- Informacje o dokumencie -->
      <div class="row mb-3">
        <div class="col-md-8">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Dokument Word został automatycznie skonwertowany do formatu tekstowego.
            Formatowanie, obrazy i niektóre elementy mogą nie być widoczne.
          </small>
        </div>
        <div class="col-md-4 text-md-end">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-copy-target="#wordContent">
            <i class="bi bi-clipboard"></i> Kopiuj tekst
          </button>
        </div>
      </div>

      <!-- Zawartość dokumentu -->
      <div class="card bg-light">
        <div class="card-body">
          <div id="wordContent" class="word-content" style="max-height: 70vh; overflow-y: auto;">
            <pre style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.95rem; line-height: 1.5; margin: 0;">{{ content }}</pre>
          </div>
        </div>
      </div>

      <!-- Statystyki tekstu -->
      <div class="row mt-3">
        <div class="col-md-6">
          <small class="text-muted">
            <i class="bi bi-file-text me-1"></i>
            Liczba znaków: <span id="charCount">{{ content|length }}</span>
          </small>
        </div>
        <div class="col-md-6 text-md-end">
          <small class="text-muted">
            <i class="bi bi-paragraph me-1"></i>
            Liczba akapitów: <span id="paragraphCount">{{ content.split('\n\n')|length }}</span>
          </small>
        </div>
      </div>

    {% else %}
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Dokument Word jest pusty lub nie zawiera tekstu do wyświetlenia.
      </div>

      <div class="text-center mt-4">
        <a href="{{ url_for('document_download', doc_id=doc.id) }}" class="btn btn-primary">
          <i class="bi bi-download"></i> Pobierz dokument Word
        </a>
      </div>
    {% endif %}
  </div>
</div>

<!-- Dodatkowe informacje -->
<div class="card mt-3">
  <div class="card-header">
    <h6 class="mb-0">
      <i class="bi bi-info-circle me-2"></i>Informacje o dokumencie
    </h6>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <ul class="list-unstyled mb-0">
          <li><strong>Nazwa pliku:</strong> {{ doc.original_filename }}</li>
          <li><strong>Typ MIME:</strong> {{ doc.mime_type or "Nieznany" }}</li>
          <li><strong>Data dodania:</strong> {{ doc.upload_time.strftime('%Y-%m-%d %H:%M') }}</li>
        </ul>
      </div>
      <div class="col-md-6">
        <ul class="list-unstyled mb-0">
          <li><strong>Sygnatura:</strong> {{ doc.sygnatura or "Brak" }}</li>
          <li><strong>Typ dokumentu:</strong> {{ doc.doc_type or "Nieznany" }}</li>
          {% if doc.last_modified %}
          <li><strong>Ostatnia modyfikacja:</strong> {{ doc.last_modified.strftime('%Y-%m-%d %H:%M') }}</li>
          {% endif %}
        </ul>
      </div>
    </div>

    {% if doc.note %}
    <div class="mt-3">
      <strong>Notatka:</strong>
      <div class="card bg-light mt-2">
        <div class="card-body py-2">
          <small>{{ doc.note }}</small>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Policz słowa w dokumencie
document.addEventListener('DOMContentLoaded', function() {
  const content = document.getElementById('wordContent');
  if (content) {
    const text = content.innerText || content.textContent || '';
    const words = text.trim().split(/\s+/).filter(word => word.length > 0);

    // Dodaj statystykę słów
    const charCountElement = document.getElementById('charCount');
    if (charCountElement && charCountElement.parentNode) {
      const wordStats = document.createElement('small');
      wordStats.className = 'text-muted ms-3';
      wordStats.innerHTML = '<i class="bi bi-fonts me-1"></i>Liczba słów: ' + words.length;
      charCountElement.parentNode.parentNode.appendChild(wordStats);
    }
  }
});

// Funkcja wyszukiwania w tekście
function searchInDocument() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const content = document.getElementById('wordContent');

  if (!searchTerm) {
    // Jeśli brak wyszukiwania, przywróć oryginalny tekst
    location.reload();
    return;
  }

  const originalText = content.innerText || content.textContent;
  const highlightedText = originalText.replace(
    new RegExp(searchTerm, 'gi'),
    '<mark>$&</mark>'
  );

  content.innerHTML = '<pre style="white-space: pre-wrap; font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.95rem; line-height: 1.5; margin: 0;">' + highlightedText + '</pre>';
}

// Dodaj pasek wyszukiwania po załadowaniu strony
document.addEventListener('DOMContentLoaded', function() {
  const contentCard = document.querySelector('.word-content').closest('.card');
  if (contentCard && document.getElementById('wordContent')) {
    const searchBar = document.createElement('div');
    searchBar.className = 'card-header d-flex align-items-center';
    searchBar.innerHTML = `
      <div class="input-group input-group-sm">
        <span class="input-group-text">
          <i class="bi bi-search"></i>
        </span>
        <input type="text" id="searchInput" class="form-control" placeholder="Wyszukaj w dokumencie..." onkeyup="if(event.key==='Enter') searchInDocument()">
        <button class="btn btn-outline-secondary" type="button" onclick="searchInDocument()">
          Szukaj
        </button>
        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('searchInput').value=''; location.reload();">
          Wyczyść
        </button>
      </div>
    `;
    contentCard.insertBefore(searchBar, contentCard.firstChild);
  }
});
</script>
{% endblock %}